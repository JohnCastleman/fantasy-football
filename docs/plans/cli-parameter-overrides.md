# CLI Parameter Overrides - Planning Document

## Prerequisites

This implementation requires completion of the **Display and Output Enhancements** work documented in `cli-parameter-prerequisites.md`.

**Prerequisites include**:

- Settings refactoring (clearer names, simplified types)
- Markdown table output format
- File output capability using Node.js streams

**See**: [cli-parameter-prerequisites.md](cli-parameter-prerequisites.md) for full details.

## CLI Framework Reference

This implementation will use **commander.js** for command-line parsing and option handling:

- **NPM Package**: [commander](https://www.npmjs.com/package/commander)
- **GitHub Repository**: <https://github.com/tj/commander.js>
- **Documentation**: <https://github.com/tj/commander.js#readme>

Commander.js provides:

- POSIX-style option flags (`-v`, `--verbose`, `-h`, `--help`)
- Negatable boolean options (`--no-verbose`)
- Mutually exclusive options via `.conflicts()` method
- Type coercion and validation
- Automatic help and version generation
- Standard CLI conventions
- Well-tested, widely-used framework (40M+ weekly downloads)

## Goal

Implement command-line parameter overrides for client settings to enable flexible testing and investigative work without modifying and saving settings files.

## Motivation

Currently, investigating features like player ownership integration requires manually modifying `client/settings.js` and `client/tests/settings.js`, saving those changes, and then reverting them later. This is tedious and error-prone. Command-line parameter overrides will allow temporary configuration changes without touching the settings files.

## Settings (After Prerequisites)

### Client Settings (`client/settings.js`)

- `verbose` (boolean): Whether to show detailed ranking metadata - **default**: `false`
- `displayMaxPlayers` (number|null): Maximum number of players to display - **default**: `null` (show all)
- `outputFile` (string|null): Output file path - **default**: `null` (stdout)

### Test Settings (`client/tests/settings.js`)

- `dump` (boolean): Whether to use TSV format - **default**: `false` (use markdown table format)
- `rankingType` (enum): Which ranking type to test - **default**: `RankingTypeEnum.DRAFT`
  - Valid values: `ROS`, `WEEKLY`, `DYNASTY`, `DRAFT`
  - `null` or missing → defensive default is `DRAFT`
- `positions` (array|null): Which positions to test - **default**: `null` (all positions)
  - Can be array of `PositionEnum` values: `QB`, `RB`, `WR`, `TE`, `K`, `DST`

## CLI Parameter Design

### Short Option Codes (Final)

Following POSIX standards and CLI best practices:

| Short | Long | Type | Purpose |
|-------|------|------|---------|
| `-h` | `--help` | flag | Display help information |
| `-V` | `--version` | flag | Display version number |
| `-v` | `--verbose` | boolean | Enable verbose output |
| `-d` | `--dump` | boolean | Enable TSV output format |
| `-o` | `--output` | string | Output file path |
| `-t` | `--type` | enum | Ranking type (DRAFT\|DYNASTY\|ROS\|WEEKLY) |
| `-p` | `--position` | string | Position (repeatable: `-p QB -p RB`) |
| `-m` | `--max-players` | number | Maximum players to display |

**Notes**:

- Case-distinct `-V` (version) vs `-v` (verbose) follows standard CLI conventions (git, npm, node)
- `-m` chosen for max-players (mnemonic: "max")
- `-o` is the universal standard for output files
- Commander.js distinguishes case even on Windows

### Priority Levels

**CLI Parameters override Settings Files**:

1. **CLI Parameter Value** (highest priority): Explicitly provided on command line
2. **Settings File Value** (middle priority): Configured in `client/settings.js` or `client/tests/settings.js`
3. **Built-in Default** (lowest priority): Hardcoded fallback when setting is missing/null

**Standard Override Behavior**:

- Omit CLI param → use Settings file value
- Provide CLI param → override Settings file value
- Use `--no-<flag>` → explicitly set boolean to false

## CLI Parameters

### `-h, --help`

**Type**: Flag (boolean)

**Behavior**:

- Displays comprehensive help information
- Auto-generated by commander.js
- Includes command description, option list, usage examples
- Exits after displaying help

**Usage**:

```bash
npm test -- --help
npm test -- -h
```

### `-V, --version`

**Type**: Flag (boolean)

**Behavior**:

- Displays version number from package.json
- Auto-generated by commander.js
- Exits after displaying version

**Usage**:

```bash
npm test -- --version
npm test -- -V
```

### `-v, --verbose, --no-verbose`

**Type**: Boolean (negatable)

**Values**:

- `-v` or `--verbose`: Enable verbose output (detailed ranking metadata)
- `--no-verbose`: Explicitly disable verbose output
- Omit: Use Settings file value

**Overrides**: `Settings.verbose`

**Usage**:

```bash
npm test -- --verbose          # Enable
npm test -- -v                 # Enable (short)
npm test -- --no-verbose       # Explicitly disable
```

### `-m, --max-players <number>`

**Type**: Integer

**Values**:

- `-m 5` or `--max-players 5`: Show maximum of 5 players
- `-m 0` or `--max-players 0`: Show all players
- Omit: Use Settings file value (default: null = all players)

**Overrides**: `Settings.displayMaxPlayers`

**Usage**:

```bash
npm test -- --max-players 10
npm test -- -m 5
npm test -- -m 0               # Show all
```

**Testing Strategy**:

Once this parameter is implemented, comprehensive testing of `displayMaxPlayers` behavior becomes trivial:

```bash
# Test various limits
npm test -- -m 1 -t DRAFT -p QB    # Show exactly 1 player
npm test -- -m 5 -t DRAFT -p QB    # Show exactly 5 players
npm test -- -m 0 -t DRAFT -p QB    # Show all players
npm test -- -t DRAFT -p QB          # Use settings file default (null = all)

# Verify message output
# - With limit: "... (showing 5 of X players)"
# - Without limit: no truncation message
```

This addresses the test coverage gap identified in PR #2 review, where `displayMaxPlayers` null/0/undefined handling lacked explicit test coverage. With CLI parameters, all edge cases can be tested without modifying settings files.

### `-d, --dump, --no-dump`

**Type**: Boolean (negatable)

**Values**:

- `-d` or `--dump`: Enable TSV output format
- `--no-dump`: Explicitly use markdown table format
- Omit: Use TestSettings file value (default: markdown table)

**Overrides**: `TestSettings.dump`

**Usage**:

```bash
npm test -- --dump             # TSV format
npm test -- -d                 # TSV format (short)
npm test -- --no-dump          # Markdown table format
```

### `-o, --output <file>`

**Type**: String (filename)

**Values**:

- `-o rankings.txt` or `--output rankings.txt`: Write output to file
- Omit: Output to stdout

**Behavior**:

- `-o` controls **destination** (stdout vs file), NOT format
- Format is controlled by `dump` flag:
  - `dump=false` → markdown table (to stdout or file)
  - `dump=true` → TSV (to stdout or file)

**Overrides**: `Settings.outputFile`

**Usage**:

```bash
npm test -- -o rankings.md                    # Markdown table to file
npm test -- --dump -o rankings.tsv            # TSV to file
npm test -- -d -o output.tsv                  # TSV to file (short)
# No -o flag outputs to stdout (console)
```

### `-t, --type <type>`

**Type**: Enum (RankingTypeEnum)

**Values**:

- `-t DRAFT`, `--type DRAFT`: Use DRAFT rankings
- `-t DYNASTY`, `--type DYNASTY`: Use DYNASTY rankings
- `-t ROS`, `--type ROS`: Use Rest-of-Season rankings
- `-t WEEKLY`, `--type WEEKLY`: Use Weekly rankings
- Omit: Use TestSettings file value

**Valid Values**: `DRAFT`, `DYNASTY`, `ROS`, `WEEKLY` (case-insensitive)

**Overrides**: `TestSettings.rankingType`

**Usage**:

```bash
npm test -- --type WEEKLY
npm test -- -t ROS
npm test -- -t draft           # Case-insensitive
```

### `-p, --position <pos>`

**Type**: String (repeatable)

**Values**:

- Single position: `-p QB`
- Multiple positions (repeatable): `-p QB -p RB -p WR`
- Comma-separated: `--position QB,RB,WR`
- Omit: Use TestSettings file value (default: all positions)

**Valid Position Values**: `QB`, `RB`, `WR`, `TE`, `K`, `DST` (case-insensitive)

**Overrides**: `TestSettings.positions`

**Usage**:

```bash
npm test -- --position QB
npm test -- -p QB -p RB -p WR                 # Repeatable
npm test -- --position QB,RB,WR               # Comma-separated
npm test -- -p qb                             # Case-insensitive
```

## Implementation Approach

### Step 1: Install commander.js

```bash
npm install commander
```

### Step 2: Create CLI Module (`client/cli-args.js`)

```javascript
import { Command, Option } from 'commander';
import { RankingTypeEnum, PositionEnum } from '../common/index.js';
import { readFileSync } from 'fs';

// Read version from package.json
const packageJson = JSON.parse(readFileSync('package.json', 'utf8'));

const program = new Command();

program
  .name('ff-rankings')
  .description('Fantasy Football Rankings CLI')
  .version(packageJson.version, '-V, --version', 'Display version number')
  .helpOption('-h, --help', 'Display help information');

// Boolean options with negation
program
  .option('-v, --verbose', 'Enable verbose output (detailed ranking metadata)')
  .option('--no-verbose', 'Explicitly disable verbose output')
  .option('-d, --dump', 'Enable TSV output format')
  .option('--no-dump', 'Explicitly disable TSV format (use display-style)');

// Value options
program
  .option('-m, --max-players <number>', 'Maximum number of players to display (0 = all)', parseInt)
  .option('-o, --output <file>', 'Output file path (markdown table if not dump mode, TSV if dump mode)')
  .option('-t, --type <type>', 'Ranking type (DRAFT|DYNASTY|ROS|WEEKLY)', (val) => val.toUpperCase());

// Position option (repeatable or comma-separated)
program
  .option('-p, --position <positions>', 'Position(s) to include (QB,RB,WR,TE,K,DST) - repeatable or comma-separated', 
    (val, previous) => {
      // Handle comma-separated values
      const positions = val.toUpperCase().split(',');
      return previous ? [...previous, ...positions] : positions;
    }, 
    []);

// Add usage examples to help
program.addHelpText('after', `

Examples:
  Display WEEKLY QB rankings with verbose output:
    $ npm test -- -v -t WEEKLY -p QB

  Dump ROS rankings for all positions to TSV file:
    $ npm test -- -d -t ROS -o rankings.tsv

  Show top 10 RB and WR in markdown table:
    $ npm test -- -m 10 -p RB -p WR -o output.md

  Multiple positions (comma-separated):
    $ npm test -- -t WEEKLY -p QB,RB,WR
`);

// Validate ranking type
program.hook('preAction', (thisCommand) => {
  const opts = thisCommand.opts();
  
  if (opts.type) {
    const validTypes = ['DRAFT', 'DYNASTY', 'ROS', 'WEEKLY'];
    if (!validTypes.includes(opts.type)) {
      thisCommand.error(`Invalid ranking type: ${opts.type}. Must be one of: ${validTypes.join(', ')}`);
    }
  }
  
  if (opts.position && opts.position.length > 0) {
    const validPositions = ['QB', 'RB', 'WR', 'TE', 'K', 'DST'];
    const invalidPositions = opts.position.filter(p => !validPositions.includes(p));
    if (invalidPositions.length > 0) {
      thisCommand.error(`Invalid position(s): ${invalidPositions.join(', ')}. Must be one of: ${validPositions.join(', ')}`);
    }
  }
});

program.parse();

export const cliOptions = program.opts();
```

### Step 3: Update Settings Modules

**client/settings.js:**

```javascript
import { cliOptions } from './cli-args.js';

const Settings = {
  // CLI overrides Settings file values
  verbose: cliOptions.verbose ?? false,
  displayMaxPlayers: cliOptions.maxPlayers ?? null,
  outputFile: cliOptions.output ?? null,
  
  // ... other settings
};

export { Settings };
```

**client/tests/settings.js:**

```javascript
import { cliOptions } from '../cli-args.js';
import { RankingTypeEnum } from '../../common/index.js';

const TestSettings = {
  dump: cliOptions.dump ?? false,
  rankingType: cliOptions.type ? RankingTypeEnum[cliOptions.type] : RankingTypeEnum.DRAFT,
  positions: cliOptions.position.length > 0 
    ? cliOptions.position.map(p => PositionEnum[p])
    : null,
};

export { TestSettings };
```

### Step 4: Verify Prerequisite Features

**Note**: Markdown table output and file output capability will already be implemented as part of the **Display and Output Enhancements** prerequisites (see `cli-parameter-prerequisites.md`). This step simply verifies they work correctly before proceeding to CLI parameter implementation.

**Verification**:

- Confirm markdown table formatting works in display mode
- Confirm file output works for both display and dump modes
- Confirm the 2×2 output matrix (markdown/TSV × stdout/file) functions correctly

## Testing Strategy

### Comprehensive Test Coverage via npm Scripts

Once CLI parameters are implemented, `package.json` should include npm test rules to systematically cover all test facets:

**Current State** (pre-CLI parameters):

- Tests both DISPLAY and DUMP output modes
- Tests all four ranking types (DRAFT, DYNASTY, ROS, WEEKLY)
- 8 total combinations (2 modes × 4 types)

**Future State** (once both `-t` and `-d` CLI parameters are available):

Full 2×4 matrix coverage (all 8 combinations):

```json
"scripts": {
  "test": "node client/tests/index.js",
  
  "test:display-draft": "npm test -- -t DRAFT",
  "test:display-dynasty": "npm test -- -t DYNASTY",
  "test:display-ros": "npm test -- -t ROS",
  "test:display-weekly": "npm test -- -t WEEKLY",
  
  "test:dump-draft": "npm test -- -d -t DRAFT",
  "test:dump-dynasty": "npm test -- -d -t DYNASTY",
  "test:dump-ros": "npm test -- -d -t ROS",
  "test:dump-weekly": "npm test -- -d -t WEEKLY",
  
  "test:display-all-types": "npm run test:display-draft && npm run test:display-dynasty && npm run test:display-ros && npm run test:display-weekly",
  "test:dump-all-types": "npm run test:dump-draft && npm run test:dump-dynasty && npm run test:dump-ros && npm run test:dump-weekly",
  
  "test:comprehensive": "npm run test:display-all-types && npm run test:dump-all-types"
}
```

**Transition Plan**:

During the transition from `testOutputTypes` enum to boolean `dump`, initially support `null` meaning "test both DISPLAY and DUMP modes." Once the `-d` CLI parameter is implemented, enforce either DISPLAY or DUMP (not both), and use npm scripts for comprehensive coverage.

This approach provides:

- Fast iteration during development (single ranking type, single mode)
- Full 8-combination coverage when needed (all 2×4 matrix via npm scripts)
- Grouped testing via `display-all-types` and `dump-all-types`
- No need for array-based settings (CLI parameters provide the flexibility)
- Clear documentation via named scripts

### Test Coverage

For each CLI parameter:

1. **Explicit value**: Verify override works
2. **Omitted param**: Verify Settings file value is used
3. **Negation** (for booleans): Verify `--no-flag` works
4. **Invalid values**: Verify error handling and messages
5. **Conflicts**: Verify mutually exclusive options error appropriately

### Test Scenarios

```bash
# Verbose flag
npm test -- -v                          # Should enable verbose
npm test -- --no-verbose                # Should disable verbose
npm test -- -v --no-verbose            # Should error (conflict)

# Max players
npm test -- -m 5                        # Should limit to 5
npm test -- -m 0                        # Should show all
npm test -- -m abc                      # Should error (invalid)

# Output modes
npm test -- -o output.md                # Markdown table
npm test -- -d -o output.tsv            # TSV file
npm test -- -d                          # TSV to stdout

# Ranking type
npm test -- -t WEEKLY                   # Should use WEEKLY
npm test -- -t invalid                  # Should error

# Positions
npm test -- -p QB                       # Single position
npm test -- -p QB -p RB                 # Multiple positions
npm test -- -p QB,RB,WR                 # Comma-separated
npm test -- -p INVALID                  # Should error

# Help and version
npm test -- -h                          # Should show help
npm test -- -V                          # Should show version
```

### Exit Codes

Follow standard POSIX conventions:

- `0`: Success
- `1`: General error (e.g., API failure, file write error)
- `2`: Usage error (invalid arguments, validation failure)

## Usage Examples

```bash
# Show help
npm test -- -h

# Show version
npm test -- -V

# Verbose weekly QB rankings, all players
npm test -- -v -t WEEKLY -p QB

# Top 10 RBs and WRs for ROS, save to markdown
npm test -- -t ROS -p RB,WR -m 10 -o rankings.md

# Dump all DRAFT positions to TSV file
npm test -- -d -t DRAFT -o draft-rankings.tsv

# Quick check of top 5 TEs for current week
npm test -- -t WEEKLY -p TE -m 5

# Multiple positions with repeatable flags
npm test -- -t WEEKLY -p QB -p RB -p WR -v

# Combine multiple options (short form)
npm test -- -d -t ROS -m 20 -o output.tsv

# Override settings file to disable verbose
npm test -- --no-verbose

# Show all players (override settings file limit)
npm test -- -m 0
```

## Benefits

1. **No file modifications**: Settings files remain clean and committed
2. **Rapid iteration**: Quick testing of different configurations
3. **Standard conventions**: Familiar to users of git, npm, docker
4. **Documentation**: Command history shows what was tested
5. **Scriptable**: Easy to create test scripts with specific configurations
6. **Player ownership prep**: Essential for ownership investigation work
7. **Professional UX**: Follows CLI best practices and POSIX standards

## Error Handling

### Validation Errors

```bash
$ npm test -- -t INVALID
error: Invalid ranking type: INVALID. Must be one of: DRAFT, DYNASTY, ROS, WEEKLY

$ npm test -- -p INVALID
error: Invalid position(s): INVALID. Must be one of: QB, RB, WR, TE, K, DST

$ npm test -- -m abc
error: option '-m, --max-players <number>' argument 'abc' is invalid. Expected a number.
```

### Conflict Errors

```bash
$ npm test -- -v --no-verbose
error: option '-v, --verbose' cannot be used with option '--no-verbose'
```

### File Write Errors

```bash
$ npm test -- -o /invalid/path/file.txt
error: Cannot write to file: /invalid/path/file.txt
ENOENT: no such file or directory
```

## Status

**Planning Complete** - Prerequisites documented separately in `cli-parameter-prerequisites.md`. Commander.js patterns defined. Ready for implementation after prerequisites are complete.
